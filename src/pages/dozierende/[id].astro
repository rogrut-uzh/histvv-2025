---
import DefaultLayout from '~/layouts/DefaultLayout.astro';
import Breadcrumb from "~/components/page/Breadcrumb.astro";
import MetaHead from "~/components/page/MetaHead.astro";
import SectionTextPict from "~/components/page/SectionTextPict.astro";
import loadJson from '~/lib/loadJson.js';

export async function getStaticPaths() {
  const dozenten = await loadJson('/data/tbl_dozenten.json');
  const veranstaltungen = await loadJson('/data/tbl_veranstaltungen.json');

  // Die Veranstaltungen können jetzt mehrere Dozenten enthalten!
  return dozenten.map((dozent) => {
    // Veranstaltung, wo der aktuelle Dozent beteiligt ist:
    const veranstaltungen_dozent = veranstaltungen.filter(
      (v) =>
        Array.isArray(v.dozenten) &&
        v.dozenten.some((d) => d.id_dozent === dozent.id_dozent)
    );

    return {
      params: { id: dozent.id_dozent },
      props: {
        dozent,
        veranstaltungen_dozent,
      }
    };
  });
}

// Hilfsfunktion zur Umwandlung von "1933s" zu "SS 1933" etc.
function formatSemesterLabel(id_semester) {
  if (!id_semester || id_semester.length < 5) return id_semester;
  const jahr = id_semester.slice(0, 4);
  const typ = id_semester[4].toLowerCase();
  return typ === "w" ? `${jahr} WS` : typ === "s" ? `${jahr} SS` : id_semester;
}

const { dozent, veranstaltungen_dozent } = Astro.props;

const breadcrumb = [
  { label: "Home", href: "/" },
  { label: "Dozierende", href: "/dozierende/" },
  { label: `${dozent.nachname}, ${dozent.vorname}`, href: `/dozierende/${dozent.id_dozent}/` }
];

const website_title = "Historische Vorlesungsverzeichnisse der Universität Zürich";
const page_title = `${dozent.nachname}, ${dozent.vorname}`;
const website_byline = "1833 - 1900";
const website_description = "Detailangaben zum Dozenten / zur Dozentin.";

---

<DefaultLayout>
  <Breadcrumb items={breadcrumb} />

  <MetaHead slot="head"
    title={`${dozent.nachname}, ${dozent.vorname} | ${website_title} ${website_byline}`}
    description={`${website_description}`}
  />

  <SectionTextPict>
    <h1>{dozent.nachname}, {dozent.vorname}</h1>

    <p>
      {dozent.geboren && (
        <>
          <span><span style="width:18px;display:inline-block;">&#10025;</span>{dozent.geboren}</span>
          {dozent.gestorben && (
            <>
              <span style="margin-left:30px;display:inline-block;"><span style="width:18px;display:inline-block;">&dagger;</span>{dozent.gestorben}</span>
            </>
          )}
        </>
      )}
      {!dozent.geboren && dozent.gestorben && (
        <>
          <span><span style="width:18px;display:inline-block;">&dagger;</span>{dozent.gestorben}</span>
        </>
      )}
    </p>

    {dozent.gagliardi && <p>{dozent.gagliardi}</p>}
    {dozent.fak && <p>{dozent.fak}</p>}
    {dozent.fachgebiet && <p>Fachgebiet: {dozent.fachgebiet}</p>}
    {(dozent.habilitation || dozent.berufung) && (
      <p>
        {[dozent.habilitation, dozent.berufung].filter(Boolean).join(', ')}
      </p>
    )}
    {dozent.dekanat && <p>{dozent.dekanat}</p>}
    {dozent.rektor && <p>{dozent.rektor}</p>}
    {(dozent.pnd || dozent.wikidata || dozent.wikipedia || (dozent.url && dozent.url.length > 0)) && (
      <p>
        {dozent.pnd && (
          <>
            <a class="Link" href={`https://d-nb.info/gnd/${dozent.pnd}`}>GND</a><br/>
          </>
        )}
        {dozent.wikidata && (
          <>
            <a class="Link" href={`https://www.wikidata.org/wiki/${dozent.wikidata}`} target="_blank" rel="noopener">Wikidata</a><br/>
          </>
        )}
        {dozent.wikipedia && (
          <>
            <a class="Link" href={dozent.wikipedia} target="_blank" rel="noopener">Wikipedia</a><br/>
          </>
        )}
        {Array.isArray(dozent.url) && dozent.url.map((u, i) => (
            <a class="Link" href={u} target="_blank" rel="noopener">{u}</a><br/>
        ))}
      </p>
    )}

    <h2>Veranstaltungen</h2>
    <table class="tablesorter">
      <thead>
        <tr>
          <th>#</th>
          <th>Semester</th>
          <th>Veranstaltung</th>
          <th>Grad</th>
          <th>Funktion</th>
        </tr>
      </thead>
      <tbody>
        {veranstaltungen_dozent.map((v, index) => {
          // Alle passenden Dozenten für diese Veranstaltung und diesen Dozenten
          const meineInfos = (Array.isArray(v.dozenten) ? v.dozenten : []).filter(d => d.id_dozent === dozent.id_dozent);
          return (
            <tr>
              <td>{index + 1}</td>
              <td>
                <a href={`/vv/${v.id_semester}#${v.id_veranstaltung}`}>{formatSemesterLabel(v.id_semester)}</a>              </td>
              <td>{v.thema}</td>
              <td>
                {meineInfos.map((d, i) => (
                  <>
                    {i > 0 && ', '}
                    {d.grad || ''}
                  </>
                ))}
              </td>
              <td>
                {meineInfos.map((d, i) => (
                  <>
                    {i > 0 && ', '}
                    {d.funktion || ''}
                  </>
                ))}
              </td>
            </tr>
          )
        })}
      </tbody>
    </table>
  </SectionTextPict>
</DefaultLayout>
