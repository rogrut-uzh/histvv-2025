---
export const prerender = false;

import DefaultLayout from '~/layouts/DefaultLayout.astro';
import Breadcrumb from "~/components/page/Breadcrumb.astro";
import MetaHead from "~/components/page/MetaHead.astro";
import SectionTextPict from "~/components/page/SectionTextPict.astro";
import { pageinfo } from '~/constants.ts';
import { fetchWikipediaLinks, fetchWikipediaImage } from '~/lib/wiki';
import { semesterLabel } from '~/lib/semester';
import { esSearch } from '~/server/es';

// Helper
function getWikipediaTitle(wiki_url?: string) {
  const m = wiki_url?.match?.(/\/wiki\/(.+)$/);
  return m ? decodeURIComponent(m[1]) : null;
}

const dozentId = String(Astro.params.id ?? '').trim();
if (!dozentId) return new Response('UngÃ¼ltige Dozenten-ID', { status: 400 });

// 1) Dozent laden (aus ES)
let dozent: any = null;
try {
  const { hits } = await esSearch({
    query: { bool: { filter: [ { term: { typ: 'dozent' } }, { term: { id: dozentId } } ] } },
    size: 1,
    _source: [
      'id','nachname','vorname','geboren','gestorben','fak','fachgebiet',
      'habilitation','berufung','pnd','wikidata','wikipedia',
      'external_urls','gagliardi','dekanat','rektor'
    ]
  });
  dozent = hits?.hits?.[0]?._source ?? null;
} catch (e: any) {
  return new Response(`Suche nicht erreichbar: ${e?.message || e}`, { status: 502 });
}
if (!dozent) {
  return new Response('Dozierender nicht gefunden', { status: 404 });
}

// 2) Veranstaltungen des Dozenten laden
let veranstaltungen_dozent: any[] = [];
try {
  const { hits } = await esSearch({
    query: { bool: { filter: [
      { term: { typ: 'veranstaltung' } },
      { term: { 'dozenten.id_dozent': dozentId } }
    ] } },
    size: 5000,
    _source: [
      'id_veranstaltung','id_semester','thema','thema_anmerkung','zusatz',
      'vorlesungsnummer','zeit','wochenstunden','ort','dozenten'
    ]
  });
  veranstaltungen_dozent = (hits?.hits ?? [])
    .map((h:any) => h._source)
    .sort((a:any,b:any) => String(a.id_semester).localeCompare(String(b.id_semester)));
} catch (e: any) {
  return new Response(`Suche nicht erreichbar: ${e?.message || e}`, { status: 502 });
}

// 3) Wikipedia/Wikidata-Infos aufbereiten
let wikipediaDe: string | null = null;
let wikipediaEn: string | null = null;
let wikidataLink: string | null = null;
let wikipediaImage: string | null = null;

if (!dozent.wikidata && !dozent.wikipedia) {
  // nichts
} else if (!dozent.wikidata && dozent.wikipedia) {
  wikipediaDe = dozent.wikipedia;
  const t = getWikipediaTitle(wikipediaDe);
  if (t) wikipediaImage = await fetchWikipediaImage("de", t, 300);
} else if (dozent.wikidata) {
  const links = await fetchWikipediaLinks(dozent.wikidata);
  wikipediaDe = links.de || null;
  wikipediaEn = links.en || null;
  wikidataLink = `https://www.wikidata.org/wiki/${dozent.wikidata}`;
  const tDe = wikipediaDe ? getWikipediaTitle(wikipediaDe) : null;
  const tEn = wikipediaEn ? getWikipediaTitle(wikipediaEn) : null;
  if (tDe) {
    wikipediaImage = await fetchWikipediaImage("de", tDe, 300);
  } else if (tEn) {
    wikipediaImage = await fetchWikipediaImage("en", tEn, 300);
  }
}

// externe Links
const externalLinks: string[] = Array.isArray(dozent.external_urls) ? dozent.external_urls : [];

// breadcrumb & Titel
const breadcrumb = [
  { label: "Home", href: "/" },
  { label: "Dozierende", href: "/dozierende/" },
  { 
    label: dozent.vorname ? `${dozent.nachname}, ${dozent.vorname}` : dozent.nachname, 
    href: `/dozierende/${dozent.id}/`
  }
];
const page_title = dozent.vorname ? `${dozent.nachname}, ${dozent.vorname}` : dozent.nachname;
---

<DefaultLayout>
  <Breadcrumb items={breadcrumb} />

  <MetaHead slot="head"
    title={`${page_title} | ${pageinfo.title} ${pageinfo.byline}`}
    description={`${pageinfo.description}`}
  />

  <SectionTextPict>
    {dozent.id !== "vakant" ? (
      <>
        {wikipediaImage && (
          <img class="wiki-image" src={wikipediaImage} alt="Bild aus Wikipedia" />
        )}

        <h1>{dozent.nachname}{dozent.vorname ? `, ${dozent.vorname}` : ''}</h1>

        <p>
          {dozent.geboren && (
            <>
              <span>
                <span style="width:18px;display:inline-block;">&#10025;</span>
                {dozent.geboren}
              </span>
              {dozent.gestorben && (
                <span style="margin-left:30px;display:inline-block;">
                  <span style="width:18px;display:inline-block;">&dagger;</span>
                  {dozent.gestorben}
                </span>
              )}
            </>
          )}
          {!dozent.geboren && dozent.gestorben && (
            <span>
              <span style="width:18px;display:inline-block;">&dagger;</span>
              {dozent.gestorben}
            </span>
          )}
        </p>

        {dozent.gagliardi && <p>{dozent.gagliardi}</p>}
        {dozent.fak && <p>{dozent.fak}</p>}
        {dozent.fachgebiet && <p>Fachgebiet: {dozent.fachgebiet}</p>}
        {(dozent.habilitation || dozent.berufung) && (
          <p>{[dozent.habilitation, dozent.berufung].filter(Boolean).join(', ')}</p>
        )}
        {dozent.dekanat && <p>{dozent.dekanat}</p>}
        {dozent.rektor && <p>{dozent.rektor}</p>}

        {(dozent.pnd || wikipediaDe || wikipediaEn || wikidataLink || externalLinks.length > 0) && (
          <p>
            {[
              dozent.pnd && <a class="Link" href={`https://d-nb.info/gnd/${dozent.pnd}`}>GND</a>,
              wikipediaDe && <a class="Link" href={wikipediaDe} target="_blank" rel="noopener noreferrer">Wikipedia (DE)</a>,
              wikipediaEn && <a class="Link" href={wikipediaEn} target="_blank" rel="noopener noreferrer">Wikipedia (EN)</a>,
              wikidataLink && <a class="Link" href={wikidataLink} target="_blank" rel="noopener noreferrer">Wikidata</a>,
              ...externalLinks.map((u: string) =>
                <a class="Link" href={u} target="_blank" rel="noopener noreferrer">{u}</a>
              ),
            ]
              .filter(Boolean)
              .map((elem, i, arr) => (
                <span key={i}>
                  {elem}
                  {i < arr.length - 1 && <br />}
                </span>
              ))}
          </p>
        )}

        <h2>Veranstaltungen</h2>
        <table class="tablesorter">
          <thead>
            <tr>
              <th>#</th>
              <th>Semester</th>
              <th>Veranstaltung</th>
              <th>Grad</th>
              <th>Funktion</th>
            </tr>
          </thead>
          <tbody>
            {veranstaltungen_dozent.map((v:any, index:number) => {
              const meineInfos = (Array.isArray(v.dozenten) ? v.dozenten : [])
                .filter((d:any) => (d.id_dozent ?? '') === dozentId);

              return (
                <tr key={v.id_veranstaltung ?? index}>
                  <td>{index + 1}</td>
                  <td>
                    <a href={`/vv/${v.id_semester}#${v.id_veranstaltung}`}>
                      {semesterLabel(v.id_semester)}
                    </a>
                  </td>
                  <td>{v.thema}</td>
                  <td>
                    {meineInfos.map((d:any, i:number) => (
                      <span key={`grad-${i}`}>
                        {i > 0 && ', '}
                        {d.grad || ''}
                      </span>
                    ))}
                  </td>
                  <td>
                    {meineInfos.map((d:any, i:number) => (
                      <span key={`funktion-${i}`}>
                        {i > 0 && ', '}
                        {d.funktion || ''}
                      </span>
                    ))}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </>
    ) : (
      <>
        <h1>Vakant</h1>
        <p>Zum Zeitpunkt des Drucks waren die Dozierenden noch nicht bekannt.</p>
      </>
    )}
  </SectionTextPict>
</DefaultLayout>
